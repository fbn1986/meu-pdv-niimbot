<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDV Pro (55mm)</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.0/dist/JsBarcode.all.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        /* --- ESTILOS DE TELA (Operação) --- */
        body { font-family: sans-serif; margin: 0; padding: 0; background: #dfe6e9; }
        header { background: #2d3436; color: white; padding: 15px; text-align: center; font-weight: bold; }
        
        .container { display: flex; flex-wrap: wrap; padding: 10px; gap: 10px; justify-content: center; }
        
        .products-area { flex: 2; min-width: 300px; max-width: 600px; }
        .product-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; }
        .card { background: white; padding: 15px; border-radius: 8px; text-align: center; cursor: pointer; border-bottom: 3px solid #b2bec3; }
        .card:active { transform: scale(0.98); border-bottom: 1px solid #b2bec3; }
        .card-name { font-size: 0.9rem; margin-bottom: 5px; height: 32px; overflow: hidden; display: flex; align-items: center; justify-content: center; }
        .price { font-weight: bold; color: #2d3436; font-size: 1.1rem; }
        
        .cart-area { flex: 1; min-width: 300px; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .total { font-size: 1.8rem; font-weight: bold; margin: 15px 0; text-align: right; color: #2d3436; border-top: 2px dashed #b2bec3; padding-top: 10px;}
        
        button { cursor: pointer; border: none; padding: 15px; border-radius: 6px; width: 100%; margin-top: 8px; font-weight: bold; font-size: 1rem; text-transform: uppercase; }
        .btn-add { background: #0984e3; color: white; margin-bottom: 15px; }
        .btn-print { background: #00b894; color: white; box-shadow: 0 4px 0 #008f72; display: flex; align-items: center; justify-content: center; gap: 10px; font-size: 1.2rem; }
        .btn-print:active { transform: translateY(2px); box-shadow: 0 2px 0 #008f72; }
        .btn-clear { background: #fab1a0; color: #d63031; font-size: 0.8rem; padding: 10px; }

        /* --- O CUPOM PERFEITO (55mm) --- */
        #cupom-container { position: fixed; top: -9999px; left: -9999px; }
        
        #cupom-fiscal {
            /* 384px é a largura de impressão padrão de cabeças de 55mm/58mm */
            width: 384px; 
            background: white;
            color: #000;
            /* Fonte Narrow/Condensed para caber mais texto grande */
            font-family: 'Arial Narrow', 'Roboto Condensed', sans-serif; 
            padding: 5px 10px; /* Margem lateral segura */
            box-sizing: border-box;
            border: 1px solid #ccc;
            text-transform: uppercase;
        }

        /* Tipografia de Alto Contraste para Térmica */
        .c-center { text-align: center; }
        .c-bold { font-weight: 900; } 
        
        .c-text-sm { font-size: 18px; font-weight: 600; letter-spacing: -0.5px; } 
        .c-text-md { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; } 
        .c-text-lg { font-size: 26px; font-weight: 900; } 
        .c-text-xl { font-size: 42px; font-weight: 900; letter-spacing: -1px; }

        .dashed-line { 
            border-top: 3px dashed #000; 
            margin: 15px 0; 
            width: 100%;
        }

        /* Layout de Itens Vertical */
        .item-row { 
            margin-bottom: 12px; 
            border-bottom: 1px solid #000; /* Linha sólida fina para separar itens */
            padding-bottom: 5px;
        }
        
        .item-desc { 
            font-size: 24px; 
            font-weight: 900;
            text-align: left; 
            margin-bottom: 2px;
            line-height: 1.1;
        }
        
        .item-vals { 
            display: flex; 
            justify-content: space-between; 
            font-size: 22px; 
            font-weight: bold;
            color: #000;
        }

        .total-section { display: flex; justify-content: space-between; align-items: flex-end; margin-top: 5px; }

        #barcode-container { margin: 20px 0; text-align: center; }
        #qrcode-container { display: flex; justify-content: center; margin-top: 15px; padding: 10px; background: white; }
        
        /* Modal */
        #modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:1000; align-items:center; justify-content:center; }
        .modal-box { background:white; padding:20px; border-radius:10px; width:90%; max-width:320px; }
        .input-field { width:90%; padding:15px; margin:8px 0; border:1px solid #ddd; border-radius:6px; font-size: 1.1rem; }
    </style>
</head>
<body>

<header>PDV 55mm</header>

<div class="container">
    <div class="products-area">
        <button class="btn-add" onclick="abrirModal()">+ Produto</button>
        <div id="grid-produtos" class="product-grid"></div>
    </div>

    <div class="cart-area">
        <div id="lista-carrinho-tela"><p style="color:#999; text-align:center;">Caixa Livre</p></div>
        <div class="total">R$ <span id="valor-total">0,00</span></div>
        <button class="btn-print" onclick="baixarCupomSAT()">IMPRIMIR (55mm)</button>
        <button class="btn-clear" onclick="limparCarrinho()">Limpar</button>
    </div>
</div>

<div id="cupom-container">
    <div id="cupom-fiscal">
        
        <div class="c-center c-text-lg" id="loja-nome">NOME DA LOJA</div>
        <div class="c-center c-text-sm" id="loja-endereco">Endereço da Loja, 000</div>
        <div class="c-center c-text-sm" style="margin-bottom: 5px;">CNPJ: <span id="loja-cnpj">00.000.000/0001-00</span></div>
        
        <div class="dashed-line"></div>
        
        <div class="c-center c-text-md">EXTRATO <span id="num-extrato">000</span></div>
        <div class="c-center c-text-md">CUPOM FISCAL SAT</div>
        
        <div class="dashed-line"></div>

        <div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom: 2px solid black;">
            <span class="c-text-sm">ITEM</span>
            <span class="c-text-sm">VALOR</span>
        </div>

        <div id="cupom-lista-itens"></div>

        <div class="dashed-line"></div>

        <div class="total-section">
            <span class="c-text-lg">TOTAL R$</span>
            <span class="c-text-xl" id="cupom-total-final">0,00</span>
        </div>
        
        <div class="total-section" style="margin-top:5px;">
            <span class="c-text-md">Pix</span>
            <span class="c-text-lg" id="cupom-pagamento">0,00</span>
        </div>

        <div class="dashed-line"></div>

        <div class="c-center c-text-sm">SAT No. 900012345</div>
        <div class="c-center c-text-sm" id="data-hora"></div>
        
        <div class="c-center c-bold" style="margin-top:10px; font-size:16px; letter-spacing:0px;">
            3522 0411 1111 1111 1111<br>5900 0666 0666 1234 5678
        </div>

        <div id="barcode-container">
            <svg id="barcode"></svg>
        </div>

        <div id="qrcode-container"></div>
        
        <div class="c-center c-text-md" style="margin-top:10px;">OBRIGADO!</div>
    </div>
</div>

<div id="modal">
    <div class="modal-box">
        <h3>Cadastrar</h3>
        <input type="text" id="novo-nome" class="input-field" placeholder="Nome">
        <input type="number" id="novo-preco" class="input-field" placeholder="Preço">
        <button class="btn-add" onclick="salvarProduto()">Salvar</button>
        <button class="btn-clear" onclick="document.getElementById('modal').style.display='none'">Cancelar</button>
    </div>
</div>

<script>
    // --- EDITE OS DADOS DA SUA LOJA AQUI ---
    const CONFIG = {
        nome: "RK ACESSÓRIOS",
        endereco: "Rua Bartolomeu Costa, 123 - Centro",
        cnpj: "17.346.876/0001-90"
    };

    document.getElementById('loja-nome').innerText = CONFIG.nome;
    document.getElementById('loja-endereco').innerText = CONFIG.endereco;
    document.getElementById('loja-cnpj').innerText = CONFIG.cnpj;

    // --- Lógica do Sistema ---
    let carrinho = [];
    let produtos = JSON.parse(localStorage.getItem('meus_produtos')) || [
        { id: 1, nome: "CABO HDMI 2M", preco: 25.00 },
        { id: 2, nome: "CARREGADOR TIPO C", preco: 45.00 }
    ];

    function init() { renderizarProdutos(); }

    function renderizarProdutos() {
        const grid = document.getElementById('grid-produtos');
        grid.innerHTML = '';
        produtos.forEach(p => {
            grid.innerHTML += `
                <div class="card" onclick="add(${p.id})">
                    <div class="card-name"><b>${p.nome}</b></div>
                    <div class="price">R$ ${p.preco.toFixed(2)}</div>
                </div>`;
        });
    }

    function add(id) {
        carrinho.push(produtos.find(p => p.id === id));
        atualizarCarrinho();
    }

    function atualizarCarrinho() {
        const listaTela = document.getElementById('lista-carrinho-tela');
        const totalSpan = document.getElementById('valor-total');
        
        if (carrinho.length === 0) {
            listaTela.innerHTML = '<p style="color:#999; text-align:center;">Caixa Livre</p>';
            totalSpan.innerText = "0,00";
            return;
        }

        listaTela.innerHTML = '';
        let total = 0;
        
        // Agrupamento para Tela
        const contagem = {};
        carrinho.forEach(item => { contagem[item.id] = (contagem[item.id] || 0) + 1; });
        const itensUnicos = [...new Set(carrinho)];

        itensUnicos.forEach(item => {
            const qtd = contagem[item.id];
            total += item.preco * qtd;
            listaTela.innerHTML += `
                <div style="display:flex; justify-content:space-between; margin-bottom:5px; border-bottom:1px dashed #ddd;">
                    <span>${qtd}x ${item.nome}</span>
                    <b>${(item.preco * qtd).toFixed(2)}</b>
                </div>`;
        });
        totalSpan.innerText = total.toFixed(2);
    }

    function limparCarrinho() { carrinho = []; atualizarCarrinho(); }
    function abrirModal() { document.getElementById('modal').style.display = 'flex'; }
    
    function salvarProduto() {
        const nome = document.getElementById('novo-nome').value.toUpperCase();
        const preco = parseFloat(document.getElementById('novo-preco').value);
        if(nome && preco) {
            produtos.push({ id: Date.now(), nome, preco });
            localStorage.setItem('meus_produtos', JSON.stringify(produtos));
            renderizarProdutos();
            document.getElementById('modal').style.display = 'none';
        }
    }

    async function baixarCupomSAT() {
        if (carrinho.length === 0) return alert("Carrinho vazio!");
        const btn = document.querySelector('.btn-print');
        const txtOriginal = btn.innerHTML;
        btn.innerHTML = "⏳ Criando...";

        const listaCupom = document.getElementById('cupom-lista-itens');
        listaCupom.innerHTML = '';
        let total = 0;
        
        const contagem = {};
        carrinho.forEach(item => { contagem[item.id] = (contagem[item.id] || 0) + 1; });
        const itensUnicos = [...new Set(carrinho)];

        itensUnicos.forEach((item, index) => {
            const qtd = contagem[item.id];
            const valorTotalItem = item.preco * qtd;
            total += valorTotalItem;

            // Layout 55mm Otimizado
            listaCupom.innerHTML += `
                <div class="item-row">
                    <div class="item-desc">${index+1}. ${item.nome}</div>
                    <div class="item-vals">
                        <span>${qtd} UN x ${item.preco.toFixed(2)}</span>
                        <span>${valorTotalItem.toFixed(2)}</span>
                    </div>
                </div>`;
        });

        document.getElementById('cupom-total-final').innerText = total.toFixed(2);
        document.getElementById('cupom-pagamento').innerText = total.toFixed(2);
        
        const agora = new Date();
        document.getElementById('data-hora').innerText = agora.toLocaleString('pt-BR');
        document.getElementById('num-extrato').innerText = Math.floor(Math.random() * 9999);

        // Barcode calibrado para 55mm
        JsBarcode("#barcode", "35220412345678901234", {
            format: "CODE128",
            displayValue: false,
            height: 70,  
            width: 3,    
            margin: 0
        });

        // QR Code
        document.getElementById("qrcode-container").innerHTML = "";
        new QRCode(document.getElementById("qrcode-container"), {
            text: "https://fazenda.gov.br",
            width: 160,
            height: 160,
            correctLevel : QRCode.CorrectLevel.L
        });

        try {
            const cupomEl = document.getElementById('cupom-fiscal');
            // Scale 2 garante nitidez (384px * 2 = 768px de largura real na imagem)
            const canvas = await html2canvas(cupomEl, { scale: 2, backgroundColor: "#ffffff" });
            
            const link = document.createElement('a');
            link.download = `SAT-55mm-${Date.now()}.jpg`;
            link.href = canvas.toDataURL('image/jpeg', 0.95);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
        } catch (e) {
            alert("Erro: " + e);
        } finally {
            btn.innerHTML = txtOriginal;
        }
    }

    init();
</script>

</body>
</html>